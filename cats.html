<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cats – Animals of Asparuhovo</title>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="site-header">
  <div class="logo">Animals of Asparuhovo</div>
  <nav class="main-nav">
    <a href="index.html">Home</a>
    <a href="cats.html" class="active">Cats</a>
    <a href="dogs.html">Dogs</a>
    <a href="competition.html">Competition</a>
  </nav>
</header>

<main class="content">

  <section class="page-intro">
    <h1>Cats of Small Pier</h1>
    <p>Local cats living around the Small Pier. Each one has history, allies, and enemies.</p>
  </section>

  <section class="card-grid">

    <!-- Mini-Lapa -->
    <article class="card" data-location="small-pier">
      <div class="card-inner">
        <div class="card-front">
          <h2>Mini-Lapa</h2>
          <div class="meta">2 years • Likes milk • Grumpy</div>
          <span class="tag">Small Pier</span>
          <div class="card-hint">Tap to flip</div>
        </div>
        <div class="card-back">
          <h3>Story</h3>
          <p>
            Mini-Lapa is the son and almost exact copy of the old cat Lapa.
            He loves milk but strongly dislikes being petted by people.
          </p>

          <div class="rating" data-id="mini-lapa">
            <div class="stars">
              <span data-star="1">★</span>
              <span data-star="2">★</span>
              <span data-star="3">★</span>
              <span data-star="4">★</span>
              <span data-star="5">★</span>
            </div>
            <div class="rating-info">
              <span class="avg">0.0</span> / 5 · <span class="votes">0</span> votes
            </div>
          </div>
          <div class="ach"></div>
        </div>
      </div>
    </article>

    <!-- Elizabeth -->
    <article class="card" data-location="small-pier">
      <div class="card-inner">
        <div class="card-front">
          <h2>Elizabeth</h2>
          <div class="meta">2 years • Friendly • Curious</div>
          <span class="tag">Small Pier</span>
          <div class="card-hint">Tap to flip</div>
        </div>
        <div class="card-back">
          <h3>Story</h3>
          <p>
            Elizabeth is Mini-Lapa’s twin. She looks similar to him but has
            a completely different personality — she loves people and attention.
          </p>

          <div class="rating" data-id="elizabeth">
            <div class="stars">
              <span data-star="1">★</span>
              <span data-star="2">★</span>
              <span data-star="3">★</span>
              <span data-star="4">★</span>
              <span data-star="5">★</span>
            </div>
            <div class="rating-info">
              <span class="avg">0.0</span> / 5 · <span class="votes">0</span> votes
            </div>
          </div>
          <div class="ach"></div>
        </div>
      </div>
    </article>

    <!-- Black -->
    <article class="card" data-location="small-pier" id="black">
      <div class="card-inner">
        <div class="card-front">
          <h2>Black</h2>
          <div class="meta">4 years • Slim • Friendly</div>
          <span class="tag">Small Pier</span>
          <div class="card-hint">Tap to flip</div>
        </div>
        <div class="card-back">
          <h3>Story</h3>
          <p>
            Black is Lapa’s wife and the mother of his kittens. She is slim,
            kind to people, and known as a good and generous mother.
          </p>

          <div class="rating" data-id="black">
            <div class="stars">
              <span data-star="1">★</span>
              <span data-star="2">★</span>
              <span data-star="3">★</span>
              <span data-star="4">★</span>
              <span data-star="5">★</span>
            </div>
            <div class="rating-info">
              <span class="avg">0.0</span> / 5 · <span class="votes">0</span> votes
            </div>
          </div>
          <div class="ach"></div>
        </div>
      </div>
    </article>

    <!-- Martha -->
    <article class="card" data-location="small-pier">
      <div class="card-inner">
        <div class="card-front">
          <h2>Martha</h2>
          <div class="meta">5 years • Sporty • Independent</div>
          <span class="tag">Small Pier</span>
          <div class="card-hint">Tap to flip</div>
        </div>
        <div class="card-back">
          <h3>Story</h3>
          <p>
            Martha is Lapa’s ex and comes from the city Base. She is enemies
            with Black and almost everyone else. Sporty, beautiful, and lives
            alone at the end of the pier. Many people prefer her.
          </p>

          <div class="rating" data-id="martha">
            <div class="stars">
              <span data-star="1">★</span>
              <span data-star="2">★</span>
              <span data-star="3">★</span>
              <span data-star="4">★</span>
              <span data-star="5">★</span>
            </div>
            <div class="rating-info">
              <span class="avg">0.0</span> / 5 · <span class="votes">0</span> votes
            </div>
          </div>
          <div class="ach"></div>
        </div>
      </div>
    </article>

    <!-- Timothy -->
    <article class="card" id="timothy" data-location="small-pier">
      <div class="card-inner">
        <div class="card-front">
          <h2>Timothy</h2>
          <div class="meta">4 years • Diplomatic • Calm</div>
          <span class="tag">Small Pier</span>
          <div class="card-hint">Tap to flip</div>
        </div>
        <div class="card-back">
          <h3>Story</h3>
          <p>
            Timothy came from the Southern City and had strong connections
            with local democracies there. He was once a rival of Lapa, but
            now they are friends.
          </p>

          <div class="rating" data-id="timothy">
            <div class="stars">
              <span data-star="1">★</span>
              <span data-star="2">★</span>
              <span data-star="3">★</span>
              <span data-star="4">★</span>
              <span data-star="5">★</span>
            </div>
            <div class="rating-info">
              <span class="avg">0.0</span> / 5 · <span class="votes">0</span> votes
            </div>
            <div class="ach"></div>
          </div>
          
        </div>
      </div>
    </article>

  </section>
</main>

<footer class="site-footer">
  Animals of Asparuhovo — Cats of Small Pier
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHA0x5tq8Po9liJMAiW-8mKfdcpVTwq_I",
  authDomain: "catweb-17233.firebaseapp.com",
  databaseURL: "https://catweb-17233-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "catweb-17233",
  storageBucket: "catweb-17233.firebasestorage.app",
  messagingSenderId: "570888605898",
  appId: "1:570888605898:web:e7f4cf78b06a8280792433"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Flip cards (tap) */
document.querySelectorAll('.card').forEach(card => {
  card.addEventListener('click', () => {
    card.classList.toggle('is-flipped');
  });
});

/* Load ratings */
async function loadRatings() {
  document.querySelectorAll('.rating').forEach(async rating => {
    const id = rating.dataset.id;
    const snap = await get(ref(db, 'ratings/' + id));
    if (!snap.exists()) return;

    const { total, votes } = snap.val();
    const avg = (total / votes).toFixed(1);

    rating.querySelector('.avg').innerText = avg;
    rating.querySelector('.votes').innerText = votes;

    rating.querySelectorAll('.stars span').forEach(star => {
      star.classList.toggle('active', star.dataset.star <= avg);
    });
  });
}

/* One vote per device */
function voteOnce(id, value) {
  const key = 'voted_' + id;
  if (localStorage.getItem(key)) return;

  localStorage.setItem(key, 'true');
  const ratingRef = ref(db, 'ratings/' + id);

  runTransaction(ratingRef, current => {
    if (current === null) return { total: value, votes: 1 };
    return { total: current.total + value, votes: current.votes + 1 };
  }).then(loadRatings);
}

/* Star click events */
document.querySelectorAll('.rating').forEach(rating => {
  const id = rating.dataset.id;
  rating.querySelectorAll('.stars span').forEach(star => {
    star.addEventListener('click', e => {
      e.stopPropagation();
      voteOnce(id, Number(star.dataset.star));
    });
  });
});

loadRatings();

</script>
<script type="module">
  import {
    syncPreassignedAchievements,
    loadAchievementsOnCards
  } from "../achievements-sync.js";

  // Run ONCE (or keep, it’s safe)
  syncPreassignedAchievements();

  loadAchievementsOnCards();
</script>

</body>
</html>
